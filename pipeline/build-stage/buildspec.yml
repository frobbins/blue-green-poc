version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo Installing source NPM dependencies...
      - npm install

  pre_build:
    commands:
      - echo Running all the unit tests...
      - npm run test

  build:
    commands:
      - echo Build started on `date`
      - echo Compiling the Node.js code...
      - npm run build

  post_build:
    commands:
      - echo executing canary deployment
      - npx serverless deploy
      # - aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:345598404247:stateMachine:abe_deployer --input '{"stackName":"wgt-guru-pink"}'
      # Add commands here to get the stack ID and start the step function
      # - STACK_ID=$(aws cloudformation describe-stacks --stack-name 'wgt-guru' --query 'Stacks[0].StackId' --output text)
      # - STATE_MACHINE_ARN=$(aws ssm get-parameter --name "/$STAGE_NAME/state_machine_arn" --query 'Parameter.Value' --output text)
      # - EXECUTION_NAME=$STAGE_NAME-$(date +%Y%m%d%H%M%S)
      # - aws stepfunctions start-execution --state-machine-arn $STATE_MACHINE_ARN --name $EXECUTION_NAME --input "{\"stackId\":\"$STACK_ID\"}"

artifacts:
  files:
    - ".serverless/cloudformation-template-update-stack.json"
    - ".serverless/serverless-state.json"
  base-directory: "./"
